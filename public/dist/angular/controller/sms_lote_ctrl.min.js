function controller(e,n,t){e.destinatarios=[],e.form={loading:!1,lote:{texto:""}},e.formReset=function(){document.getElementsByTagName("form")[0].reset(),e.form={lote:{texto:""}}},e.toggleCheckboxes=function(n){"boolean"==typeof n?angular.forEach(e.destinatarios,function(e,t){e.block_envio||(e.enviar=n)}):angular.forEach(e.destinatarios,function(e,n){e.block_envio||(e.enviar=!e.enviar)})},e.cancelOperation=function(){e.formReset(),e.destinatarios=[]},e.minimizeString=function(e){return e=e.replace(/\W+/g," "),e=e.replace(/\s+/g,""),e.toLowerCase()},e.clearPhoneNumber=function(e){return e?e.replace(/\W+/g,""):e},e.validateCellphoneNumber=function(e){if(e){var n=new RegExp(/^169(8|9)\d+/g);return n.test(e)&&11===e.length}return e},e.checkMissingNinthDigit=function(e){if(e){var n=new RegExp(/16(8|9)\d+/g);return 10===e.length&&n.test(e)}return e},e.putNinthDigit=function(e){return e?e.substr(0,2).concat("9").concat(e.substr(2,e.length-1)):e};var r=function(n){for(var t=0;t<n.length;t++){if(e.validateCellphoneNumber(n[t]))return n[t];if(e.checkMissingNinthDigit(n[t])){var r=e.putNinthDigit(n[t]);if(e.validateCellphoneNumber(r))return r}}return!1},o=function(r,o){val=e.clearPhoneNumber(r.cpfcnpj),val+="|",val+=e.clearPhoneNumber(r.numero_destinatario),n({method:"get",url:"/api/listabranca/consultar/"+val}).then(function(e){o("true"===e.data)},function(e){o(null),t.handle(e)})},a=function(e){e.enviar=!0,e.block_envio=!1},i=function(e,n){e.enviar=!1,e.block_envio=!0,e.msg_status=n};e.loadFile=function(){e.form.loading=!0;var n=new FileReader;n.onload=function(n){e.destinatarios=[];var t=$(n.target.result),l=[];$.each(t.find("tr:first>td"),function(n,t){var r=e.minimizeString(t.innerHTML);l[r]=n}),t.find("tr:first").remove(),$.each(t.find("tr"),function(n,t){var c=$(t).find("td"),s={descricao_destinatario:c[l.nome].innerText,cpfcnpj:c[l.cpfcnpj].innerText,telefone:e.clearPhoneNumber(c[l.telefone].innerText),celular:e.clearPhoneNumber(c[l.celular].innerText),celular2:e.clearPhoneNumber(c[l.celular2].innerText),enviar:!0,block_envio:!1};a(s),s.numero_destinatario=r([s.telefone,s.celular,s.celular2]),s.numero_destinatario===!1?i(s,"Nenhum número de celular válido encontrado!"):o(s,function(e){e===!0?i(s,"Encontrado na lista branca!"):null===e&&i(s,"Não foi possível verificar a lista branca! Por precaução, não será enviado!")}),e.destinatarios.push(s),e.$apply()}),toastr.success("O arquivo foi lido! "+e.destinatarios.length+" registros encontrados!"),e.form.loading=!1},n.readAsText(document.getElementById("file").files[0],"ISO-8859-15")},e.confirmOperation=function(){n({method:"post",url:"/api/smslote",data:{texto:e.form.lote.texto,descricao:e.form.lote.descricao,destinatarios:e.destinatarios}}).then(function(n){e.destinatarios=n.data},t.handle)}}angular.module("hermes_app").controller("sms_lote_ctrl",["$scope","$http","response_message_handler",controller]);