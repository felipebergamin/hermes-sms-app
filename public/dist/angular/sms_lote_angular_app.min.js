angular.module("hermes_app",["response_message_handler"]).controller("sms_lote_ctrl",function(e,n,t){e.destinatarios=[],e.form={loading:!1,lote:{texto:""}},e.formReset=function(){document.getElementsByTagName("form")[0].reset(),e.form={lote:{texto:""}}},e.toggleCheckboxes=function(n){"boolean"==typeof n?angular.forEach(e.destinatarios,function(e,t){e.block_envio||(e.enviar=n)}):angular.forEach(e.destinatarios,function(e,n){e.block_envio||(e.enviar=!e.enviar)})},e.cancelOperation=function(){e.formReset(),e.destinatarios=[]},e.minimizeString=function(e){return e=e.replace(/\W+/g," "),e=e.replace(/\s+/g,""),e.toLowerCase()},e.clearPhoneNumber=function(e){return e?e.replace(/\W+/g,""):e},e.validateCellphoneNumber=function(e){if(e){var n=new RegExp(/^169(8|9)\d+/g);return n.test(e)&&11===e.length}return e},e.checkMissingNinthDigit=function(e){if(e){var n=new RegExp(/16(8|9)\d+/g);return 10===e.length&&n.test(e)}return e},e.putNinthDigit=function(e){return e?e.substr(0,2).concat("9").concat(e.substr(2,e.length-1)):e};var r=function(n){for(var t=0;t<n.length;t++){if(e.validateCellphoneNumber(n[t]))return n[t];if(e.checkMissingNinthDigit(n[t])){var r=e.putNinthDigit(n[t]);if(e.validateCellphoneNumber(r))return r}}return!1};e.loadFile=function(){e.form.loading=!0;var n=new FileReader;n.onload=function(n){e.destinatarios=[];var t=$(n.target.result),i=[];$.each(t.find("tr:first>td"),function(n,t){var r=e.minimizeString(t.innerHTML);i[r]=n}),t.find("tr:first").remove(),$.each(t.find("tr"),function(n,t){var o=$(t).find("td"),a={descricao_destinatario:o[i.nome].innerText,cpfcnpj:o[i.cpfcnpj].innerText,telefone:e.clearPhoneNumber(o[i.telefone].innerText),celular:e.clearPhoneNumber(o[i.celular].innerText),celular2:e.clearPhoneNumber(o[i.celular2].innerText),enviar:!0,block_envio:!1};a.numero_destinatario=r([a.telefone,a.celular,a.celular2]),a.numero_destinatario===!1&&(a.enviar=!1,a.block_envio=!0,a.msg_status="Nenhum número de celular válido encontrado!"),e.destinatarios.push(a),e.$apply()}),toastr.success("O arquivo foi lido! "+e.destinatarios.length+" registros encontrados!"),e.form.loading=!1},n.readAsText(document.getElementById("file").files[0],"ISO-8859-15")},e.confirmOperation=function(){n({method:"post",url:"/api/smslote",data:{texto:e.form.lote.texto,descricao:e.form.lote.descricao,destinatarios:e.destinatarios}}).then(function(n){e.destinatarios=n.data},t.handle)}});